<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_parameter_name" th:content="${_csrf.parameterName}">
<title>レシピの変更</title>
<style>
  .preview_img { max-width: 200px; margin: 5px 0; display: block; }
  .block { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
</style>
</head>
<body>

<div th:if="${data==null}">
    <p th:text="${message}"></p>
</div>

<div th:if="${recipeDTO != null}">
<form name="update" th:action="@{/edit}" method="post"
      th:object="${recipeDTO}" enctype="multipart/form-data">

    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" th:field="*{id}">

    <h3>レシピ名</h3>
    <input type="text" th:field="*{name}">

    <h3>コメント</h3>
    <input type="text" th:field="*{comment}">

    <h3>完成画像</h3>
    <input type="file" id="main_img" th:field="*{mainImg}" accept="image/*">
    <input type="hidden" th:field="*{existingMainImgId}">

    <div id="preview_area">
        <img id="preview_main_img" 
		th:if="${recipeDTO.existingMainImgPath != null}"
        th:src="@{${recipeDTO.existingMainImgPath}}" alt="プレビュー画像">
    </div>

    <!-- 材料 -->
    <div id="ingredient_container">
        <label>材料</label>
        <label>数量</label>
        <p></p>
        <div th:each="ing, iterStat : *{ingredients}" class="block">
            <input type="text" th:field="*{ingredients[__${iterStat.index}__].name}">
            <input type="text" th:field="*{ingredients[__${iterStat.index}__].quantity}">
            <button type="button" class="add">+</button>
            <button type="button" class="delete">×</button>
        </div>
    </div>

    <h3>作り方</h3>
    <div id="step_container">

        <!-- ステップ0件の場合の初期ブロック -->
        <div th:if="${#lists.isEmpty(recipeDTO.steps)}" class="block">
            <h3 class="step_title">手順1</h3>
            <input type="text" name="steps[0].content">
			<h3 class="img_title">画像1</h3>
            <input type="file" name="steps[0].mediaFile" class="step_img">
            <img class="preview_img" src="">
            <button type="button" class="add">+</button>
            <button type="button" class="delete">×</button>
            <button type="button" class="remove_img">画像削除</button>
        </div>

        <!-- 既存ステップ -->
        <div th:each="step, iterStat : *{steps}" class="block">
            <h3 class="step_title" th:text="'手順' + ${iterStat.index + 1}"></h3>
            <input type="hidden" th:field="*{steps[__${iterStat.index}__].id}">
            <input type="text" th:field="*{steps[__${iterStat.index}__].content}">
            <h3 class="img_title" th:text="'画像' + ${iterStat.index + 1}"></h3>
            <input type="file" th:field="*{steps[__${iterStat.index}__].mediaFile}" class="step_img">
			
            <input type="hidden" th:if="*{steps[__${iterStat.index}__].existingImgId != null}"
                   th:field="*{steps[__${iterStat.index}__].existingImgId}">
				   
            <img class="preview_img"
                 th:src="${step.existingImgPath} != null ? @{${step.existingImgPath}} : ''"
                 alt="手順画像">
				 <input type="hidden" th:field="*{steps[__${iterStat.index}__].removeImg}" class="remove_img_flag" value="false">
            <button type="button" class="add">＋</button>
            <button type="button" class="delete">×</button>
            <button type="button" class="remove_img">画像削除</button>
        </div>

    </div>

    <p></p>
    <input type="submit" value="更新">
</form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfParam = document.querySelector('meta[name="_csrf_parameter_name"]').getAttribute('content');

    // メイン画像プレビュー
    const mainImgInput = document.querySelector('#main_img');
    const mainPreviewImg = document.querySelector('#preview_main_img');
    if (mainImgInput && mainPreviewImg) attachStepPreview(mainImgInput, mainPreviewImg);

    // 材料ブロック
    const IngredientContainer = document.querySelector('#ingredient_container');
    if (IngredientContainer) {
        IngredientContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('add')) addIngredient(target.closest('.block'));
            if (target.classList.contains('delete')) { target.closest('.block').remove(); IngredientRenumber(); }
        });
    }
    function addIngredient(currentBlock){
        let arrIndex = document.querySelectorAll('#ingredient_container .block').length;
        const newBlock = document.createElement('div');
        newBlock.className = 'block';
        newBlock.innerHTML=`
            <input type="text" name="ingredients[${arrIndex}].name">
            <input type="text" name="ingredients[${arrIndex}].quantity">
            <button type="button" class="add">+</button>
            <button type="button" class="delete">×</button>
        `;
        currentBlock.insertAdjacentElement('afterend', newBlock);
        IngredientRenumber();
    }
    function IngredientRenumber(){
        const blocks = IngredientContainer.querySelectorAll('.block');
        blocks.forEach((block,index)=>{
            const name = block.querySelector('input[name$=".name"]');
            const quantity = block.querySelector('input[name$=".quantity"]');
            if(name) name.name=`ingredients[${index}].name`;
            if(quantity) quantity.name=`ingredients[${index}].quantity`;
        });
    }

    // 作り方
    const stepContainer = document.querySelector('#step_container');
    if (stepContainer) {
        stepContainer.addEventListener('click', (event) => {
            const target = event.target;
            const block = target.closest('.block');
            if (!block) return;

            if(target.classList.contains('add')) addStepAfter(block);
            if(target.classList.contains('delete')) {
				const blocks = stepContainer.querySelectorAll('.block');
				if(blocks.length<=1)return;
				 block.remove(); 
				 renumberSteps(); 
			 }
			if(target.classList.contains('remove_img')) {
			    const preview = block.querySelector('.preview_img');
			    const fileInput = block.querySelector('input[type=file].step_img');
			    const hiddenImgId = block.querySelector('input[type=hidden][name$=".existingImgId"]');
			    const removeFlag = block.querySelector('input[type=hidden][name$=".removeImg"]');

			    if(preview) preview.src = "";
			    if(fileInput) fileInput.value = "";
			    if(hiddenImgId) hiddenImgId.value = "";       // 既存画像IDは空に
			    if(removeFlag) removeFlag.value = "true";    // 削除フラグを true に
			}

        });
    }

    function addStepAfter(currentBlock){
        let stepIndex = stepContainer.querySelectorAll('.block').length;
        const newBlock = document.createElement('div');
        newBlock.className='block';
        newBlock.innerHTML=`
            <h3 class="step_title">手順${stepIndex+1}</h3>
            <input type="text" name="steps[${stepIndex}].content">
			<h3 class="img_title">画像${stepIndex+1}</h3>
            <input type="file" name="steps[${stepIndex}].mediaFile" class="step_img">
            <img class="preview_img" src="">
            <button type="button" class="add">＋</button>
            <button type="button" class="delete">×</button>
            <button type="button" class="remove_img">画像削除</button>
        `;
        currentBlock.insertAdjacentElement('afterend', newBlock);
        attachStepPreview(newBlock.querySelector('.step_img'), newBlock.querySelector('.preview_img'));
        renumberSteps();
    }

    function renumberSteps(){
        const blocks = stepContainer.querySelectorAll('.block');
        blocks.forEach((block,index)=>{
			const Steptitle = block.querySelector('.step_title');
			const Imgtitle = block.querySelector('.img_title');
			if(Steptitle) Steptitle.textContent=`手順${index+1}`;
			if(Imgtitle)Imgtitle.textContent = `画像${index+1}`;
            const content = block.querySelector('input[name$=".content"]'); 
			if(content) content.name=`steps[${index}].content`;
            const img = block.querySelector('input[name$=".mediaFile"]');
			if(img) img.name=`steps[${index}].mediaFile`;
        });
    }

    // ファイル→imgプレビュー
    function attachStepPreview(input,img){
        if(!input || !img) return;//ファイル、表示場所どっちかでも無かったらプレビューできないので処理を中断
        input.addEventListener('change', e=>{
			//.files → 選ばれたファイルの配列
			//files[0] → 最初の 1 件（画像は基本 1 枚）
            const file = e.target.files[0];
            if(file){
                const objectURL = URL.createObjectURL(file); 
					img.src = objectURL;
					img.style.display = 'block'; 

            } else {
				img.src="";
			}
        });
    }

    // 既存ステッププレビュー紐付け
    if(stepContainer){
        stepContainer.querySelectorAll('.block').forEach(block=>{
            attachStepPreview(block.querySelector('.step_img'), block.querySelector('.preview_img'));
        });
    }
});
</script>

</body>
</html>
